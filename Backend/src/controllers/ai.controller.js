const aiService = require("../services/ai.service");
const ReviewHistory = require("../models/ReviewHistory.model"); // Import the ReviewHistory model


module.exports.getReview = async (req, res) => {

    const code = req.body.code;

    if (!code) {
        return res.status(400).send("Prompt is required");
    }

    try {
        const reviewContent = await aiService(code);

        // Save to history if user is logged in
        if (req.user && req.user.id) {
            await ReviewHistory.create({
                user: req.user.id,
                type: 'code_review',
                prompt: code,
                language: req.body.language || 'javascript', // Capture language from request, default to 'javascript'
                reviewContent: reviewContent,
                // displaySnippet will be generated by the pre-save hook in the model
            });
        }

        res.send(reviewContent);
    } catch (error) {
        console.error("Error getting review or saving history:", error);
        res.status(500).send("Error processing your request.");
    }
};