const imageService = require('../services/image.service')
const ReviewHistory = require("../models/ReviewHistory.model") // Import the ReviewHistory model

exports.imageReview = async (req, res) => {
  try {
    const prompt = req.body.prompt || ''
    const imageBuffer = req.file ? req.file.buffer : null

    if (!imageBuffer && !prompt) {
      return res.status(400).send('Image or prompt required')
    }

    const reviewContent = await imageService(prompt, imageBuffer)

    // Save to history if user is logged in
    if (req.user && req.user.id) {
        await ReviewHistory.create({
            user: req.user.id,
            type: 'image_review',
            prompt: prompt, // The textual prompt for the image
            language: 'image', // Set language as 'image' for image reviews
            reviewContent: reviewContent,
            imageAssociated: !!req.file,
            // displaySnippet will be generated by the pre-save hook
        })
    }

    res.send(reviewContent)
  } catch (err) {
    console.error("Error processing image review or saving history:", err)
    res.status(500).send('Error: ' + err.message)
  }
}
